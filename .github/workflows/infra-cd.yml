name: Deploy all services 
on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-24.04

    steps:
      - name: Deploy each service via docker run
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            echo "ğŸ”‘ Docker Login"
            docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

            echo "ğŸ§¼ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬"
            echo "ğŸ§¼ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ/ì´ë¯¸ì§€ ì •ë¦¬"
            docker rm -f be-server fe-web ai-server || true

            echo "â¬‡ï¸ ì´ë¯¸ì§€ Pull"
            docker pull ${{ secrets.DOCKER_USERNAME }}/be-server:latest
            # docker pull ${{ secrets.DOCKER_USERNAME }}/fe-web:latest
            # docker pull ${{ secrets.DOCKER_USERNAME }}/ai-server:latest

            echo "ğŸš€ ë°±ì—”ë“œ ì‹¤í–‰"
            docker run -d --name be-server \
              -p 8080:8080 \
              -e SPRING_DATASOURCE_URL=jdbc:mysql://${{ secrets.DATABASE_HOST }}:${{ secrets.DATABASE_PORT }}/${{ secrets.DATABASE_NAME }} \
              -e SPRING_DATASOURCE_USERNAME=${{ secrets.DATABASE_USERNAME }} \
              -e SPRING_DATASOURCE_PASSWORD=${{ secrets.DATABASE_PASSWORD }} \
              -e SMS_APIKEY=${{ secrets.SMS_APIKEY }} \
              -e SMS_SECRETKEY=${{ secrets.SMS_SECRETKEY }} \
              -e SMS_ADMINPHONE=${{ secrets.SMS_ADMINPHONE }} \
              ${{ secrets.DOCKER_USERNAME }}/be-server:latest


            # echo "ğŸš€ í”„ë¡ íŠ¸ ì‹¤í–‰"
            # docker run -d --name fe-web \
            #   -p 80:80 \
            #   ${{ secrets.DOCKER_USERNAME }}/fe-web:latest

            # echo "ğŸš€ ëª¨ë¸ ì„œë²„ ì‹¤í–‰"
            # docker run -d --name ai-server \
            #   -p 8000:8000 \
            #   ${{ secrets.DOCKER_USERNAME }}/ai-server:latest
